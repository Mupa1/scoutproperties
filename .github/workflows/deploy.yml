name: Deploy to Hostinger VPS

on:
  # Deploy only on pushes to main/master (not on pull requests)
  # This ensures only merged code gets deployed to production
  push:
    branches:
      - main
      - master
  # Allow manual deployment via GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            export APP_DIR="${{ secrets.VPS_APP_PATH }}"
            export BRANCH="${{ github.ref_name }}"

            echo "üöÄ Starting deployment..."
            echo "üìç Application directory: $APP_DIR"
            echo "üåø Branch: $BRANCH"

            # Navigate to application directory
            cd "$APP_DIR" || {
              echo "‚ùå Error: Application directory not found: $APP_DIR"
              exit 1
            }

            # Create backup
            echo "üíæ Creating backup..."
            BACKUP_DIR="$APP_DIR/backups"
            mkdir -p "$BACKUP_DIR"
            BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
            tar -czf "$BACKUP_DIR/$BACKUP_NAME.tar.gz" . \
              --exclude='node_modules' \
              --exclude='dist' \
              --exclude='.git' \
              --exclude='backups' \
              --exclude='logs' 2>/dev/null || true
            echo "‚úÖ Backup created: $BACKUP_NAME.tar.gz"

            # Pull latest changes
            echo "üì• Pulling latest changes from $BRANCH..."
            git fetch origin

            # Stash any local changes to avoid conflicts
            git stash || true

            # Remove untracked files that might conflict
            git clean -fd || true

            # Checkout and pull
            git checkout "$BRANCH"
            git reset --hard origin/"$BRANCH"
            git pull origin "$BRANCH"

            # Install and build server
            echo "üî® Building server..."
            if [ -d "server" ]; then
              cd server
              yarn install --frozen-lockfile --production=false
              yarn build
              cd ..
            fi

            # Install and build client
            echo "üî® Building client..."
            if [ -d "client" ]; then
              cd client
              yarn install --frozen-lockfile --production=false
              yarn build
              cd ..
            fi

            # Run database migrations
            echo "üóÑÔ∏è  Running database migrations..."
            if [ -d "server/prisma" ]; then
              cd server
              yarn prisma generate
              cd ..
            fi

            # Restart services
            echo "üîÑ Restarting services..."
            SERVICE_RESTARTED=false

            if command -v pm2 &> /dev/null; then
              echo "üì¶ Found PM2, attempting to restart services..."
              if pm2 restart all 2>/dev/null || pm2 start ecosystem.config.js 2>/dev/null; then
                echo "‚úÖ Services restarted via PM2"
                SERVICE_RESTARTED=true
              else
                echo "‚ö†Ô∏è  PM2 restart failed, but continuing..."
              fi
            elif command -v docker-compose &> /dev/null || command -v docker &> /dev/null; then
              if [ -f "docker-compose.yml" ]; then
                echo "üê≥ Found Docker Compose, attempting to restart services..."
                if docker-compose down && docker-compose up -d --build; then
                  echo "‚úÖ Services restarted via Docker Compose"
                  SERVICE_RESTARTED=true
                else
                  echo "‚ö†Ô∏è  Docker Compose restart failed, but continuing..."
                fi
              else
                echo "‚ö†Ô∏è  Docker found but docker-compose.yml not found"
              fi
            elif systemctl list-units --type=service 2>/dev/null | grep -q scoutproperties; then
              echo "‚öôÔ∏è  Found systemd service, attempting to restart..."
              if sudo systemctl restart scoutproperties 2>/dev/null; then
                echo "‚úÖ Services restarted via systemd"
                SERVICE_RESTARTED=true
              else
                echo "‚ö†Ô∏è  Systemd restart failed, but continuing..."
              fi
            else
              echo "‚ö†Ô∏è  No service manager found (PM2, Docker, or systemd)"
              echo "‚ö†Ô∏è  Please restart services manually after deployment"
            fi

            if [ "$SERVICE_RESTARTED" = false ]; then
              echo "‚ö†Ô∏è  Services were not automatically restarted"
              echo "‚ö†Ô∏è  Please manually restart your services to apply changes"
            fi

            echo "‚úÖ Deployment completed successfully!"
